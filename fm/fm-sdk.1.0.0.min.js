"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),FmSdk=function(){function t(e){_classCallCheck(this,t),this.v="1.0.0",this.qv="8",this.sp="fm",this.rp="res-",this.dpr=1,this.isRotate=!1,this.touchStartX=0,this.touchStartY=0,this.dpr=window.devicePixelRatio,this.gamebox=e,this.ctx=this.gamebox.getContext("2d",{willReadFrequently:!0}),this.ctx.textBaseline="top",this.ctx.font="12px 宋体",this.ctx.fillStyle="rgba(0,0,0,255)",window.ctx=this.ctx,this.cc={};var n=this;window.fmA=function(t){console.log(t)},window.fmB=function(t,e,i,a){n.fmB(t,e,i,a)},window.fmC=function(t){n.fmC(t)},window.fmD=function(t,e,i){n.fmD(t,e,i)},window.fmE=function(){return n.fmE()},window.fmF=function(t){return n.fmF(t)},window.fmG=function(t){n.fmG(t)},window.fmH=function(t){n.fmH(t)}}return _createClass(t,[{key:"init",value:function(t,e){function n(){r.update(),setTimeout(n,40)}function i(){r.draw(),requestAnimationFrame(i)}var a=this;fetch("fm."+this.v+".res?v="+this.qv).then(function(t){return t.arrayBuffer()}).then(function(e){t(new Uint8Array(e))});var r=e(this.dpr);n(),i(),window.onkeydown=function(t){if(t.isTrusted){var e=!1;switch(t.code){case"KeyA":case"ArrowLeft":r.on_key("left"),e=!0;break;case"KeyW":case"ArrowUp":r.on_key("up"),e=!0;break;case"KeyD":case"ArrowRight":r.on_key("right"),e=!0;break;case"KeyS":case"ArrowDown":r.on_key("down"),e=!0;break;case"Enter":case"Space":r.on_key("enter"),e=!0;break;case"Escape":r.on_key("cancel"),e=!0;break;case"KeyQ":case"PageUp":r.on_key("pageup"),e=!0;break;case"KeyE":case"PageDown":r.on_key("pagedown"),e=!0}e&&(t.preventDefault(),t.stopPropagation())}},/Mobi|Android|iPhone/i.test(navigator.userAgent)?(this.gamebox.addEventListener("touchstart",function(t){if(0!==t.touches.length){var e=t.touches[0];a.touchStartX=e.clientX,a.touchStartY=e.clientY}}),this.gamebox.addEventListener("touchend",function(t){if(0!==t.changedTouches.length){var e=t.changedTouches[0];a.hB(r,e.clientX,e.clientY)}})):(document.getElementById("key-map").style.display="block",this.gamebox.addEventListener("mousedown",function(t){0===t.button&&(a.touchStartX=t.clientX,a.touchStartY=t.clientY)}),this.gamebox.addEventListener("mouseup",function(t){0===t.button&&a.hB(r,t.clientX,t.clientY)})),this.hA(),window.onresize=function(){a.hA()}}},{key:"hA",value:function(){var t=document.getElementById("wrapper");t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px",this.isRotate=window.innerWidth<window.innerHeight;var e=464,n=288,i=e/n,a=window.innerWidth,r=window.innerHeight;this.isRotate&&(a=window.innerHeight,r=window.innerWidth),a/r>=i?(n=r,e=r*i):(e=a,n=a/i),this.isRotate?this.gamebox.style.transform="rotate(90deg)":this.gamebox.style.transform="rotate(0deg)",this.gamebox.style.width=e+"px",this.gamebox.style.height=n+"px",this.gamebox.width=e*this.dpr,this.gamebox.height=n*this.dpr,this.ctx.scale(e*this.dpr/464,n*this.dpr/288)}},{key:"hB",value:function(t,e,n){var i=n-this.touchStartY;if(this.isRotate&&(i=this.touchStartX-e),i>=50)return void t.on_slide_down();if(i<=-50)return void t.on_slide_up();var a=this.gamebox.getBoundingClientRect(),r=e-a.left,o=n-a.top;this.isRotate&&(r=n-a.top,o=this.gamebox.clientHeight-(e-a.left)),t.on_touch(464*r/this.gamebox.clientWidth,288*o/this.gamebox.clientHeight)}},{key:"fmB",value:function(t,e,n,i){var a=document.createElement("canvas");a.width=e,a.height=n,a.getContext("2d").putImageData(i,0,0),this.cc[t]=a}},{key:"fmC",value:function(t){if(!(t.length<5)){var e=t.slice(5);if(0!==e.length&&e.length%6==0){var n=(t[0]<<8)+t[1],i=document.createElement("canvas");i.width=16*t[3],i.height=16*t[4];for(var a=0;a<e.length/6;a++){var r=6*a,o=(e[r]<<8)+e[r+1],s=this.cc[""+this.rp+o]||null;if(null!==s){var c=(e[r+2]<<8)+e[r+3],h=(e[r+4]<<8)+e[r+5];i.getContext("2d").drawImage(s,0,0,16,16,c,h,16,16)}}this.cc[""+this.rp+n]=i}}}},{key:"fmD",value:function(t,e,n){var i=new Date,a=i.getFullYear(),r=new Uint8Array(e.length+7);r.set(e,0);var o=new Uint8Array([a>>8,a%256,i.getMonth()+1,i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()]);r.set(o,e.length),localStorage.setItem(this.sp+":meta:"+t,btoa(String.fromCharCode.apply(null,r))),localStorage.setItem(this.sp+":"+t,btoa(String.fromCharCode.apply(null,n)))}},{key:"fmE",value:function(){for(var t=[],e=0;e<5;e++){var n=localStorage.getItem(this.sp+":meta:"+e);n&&t.push(new Uint8Array(atob(n).split("").map(function(t){return t.charCodeAt(0)})))}if(0===t.length)return[];for(var i=new Uint8Array(33*t.length),a=0;a<t.length;a++)i.set(t[a],33*a);return i}},{key:"fmF",value:function(t){var e=localStorage.getItem(this.sp+":"+t);return e?new Uint8Array(atob(e).split("").map(function(t){return t.charCodeAt(0)})):[]}},{key:"fmG",value:function(t){var e=t.length;if(0!==e){if(1===t[0]){if(e<15)return;var n=t.slice(1,15),i=(n[0]<<8)+n[1],a=this.cc[""+this.rp+i];if(void 0===a)return;var r=(n[2]<<8)+n[3],o=(n[4]<<8)+n[5],s=(n[6]<<8)+n[7],c=(n[8]<<8)+n[9],h=(n[10]<<8)+n[11],l=(n[12]<<8)+n[13];this.ctx.drawImage(a,r,o,s,c,h,l,s,c)}}}},{key:"fmH",value:function(t){switch(t){case"black":this.ctx.fillStyle="rgba(0,0,0,255)";break;case"red":this.ctx.fillStyle="rgba(255,0,0,255)";break;case"blue":this.ctx.fillStyle="rgba(0,0,255,255)";break;case"purple":this.ctx.fillStyle="rgba(211,173,247,255)";break;case"white":this.ctx.fillStyle="rgba(180,180,180,255)"}}}]),t}();
